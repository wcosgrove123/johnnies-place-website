<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">Fundraiser - Johnnie's Place</title>
  <meta name="description" content="Fundraiser details for Johnnie's Place">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/jpeg" href="/images/tab-logo.jpg">
  <link rel="apple-touch-icon" href="/images/logo.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

  <!-- NAVIGATION -->
  <nav class="nav" id="nav">
    <div class="nav-inner">
      <a href="index.html" class="nav-logo">
        <img src="images/logo.png" alt="Johnnie's Place" class="logo-img">
      </a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li class="nav-dropdown">
          <a href="about.html">About</a>
          <div class="dropdown-menu">
            <a href="about.html">Our Story</a>
            <a href="mission.html">Mission</a>
            <a href="team.html">Leadership Team</a>
          </div>
        </li>
        <li class="nav-dropdown">
          <a href="blog.html">Updates</a>
          <div class="dropdown-menu">
            <a href="stay-updated.html">Stay Updated</a>
            <a href="blog.html">Blog</a>
            <a href="news.html">News</a>
          </div>
        </li>
        <li><a href="events.html">Events</a></li>
        <li class="nav-dropdown">
          <a href="support.html" class="active">Support Us</a>
          <div class="dropdown-menu">
            <a href="support.html#donate">Donate</a>
            <a href="fundraisers.html">Fundraisers</a>
            <a href="get-involved.html">Get Involved</a>
          </div>
        </li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
      <div class="nav-actions">
        <a href="support.html" class="btn btn-primary">Donate</a>
      </div>
      <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">
        <span></span><span></span><span></span>
      </button>
    </div>
    <div class="mobile-nav" id="mobileNav">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="mission.html">Mission</a>
      <a href="team.html">Leadership</a>
      <a href="stay-updated.html">Stay Updated</a>
      <a href="blog.html">Blog</a>
      <a href="news.html">News</a>
      <a href="events.html">Events</a>
      <a href="support.html">Donate</a>
      <a href="fundraisers.html">Fundraisers</a>
      <a href="get-involved.html">Get Involved</a>
      <a href="contact.html">Contact</a>
    </div>
  </nav>

  <!-- PAGE HEADER -->
  <section class="page-header">
    <div class="section-inner">
      <div id="fundraiser-header">
        <p><a href="fundraisers.html" style="color: var(--brand-primary);">Back to Fundraisers</a></p>
        <h1 id="fundraiser-title">Loading...</h1>
        <div id="fundraiser-meta"></div>
      </div>
    </div>
  </section>

  <!-- FUNDRAISER CONTENT -->
  <section class="section">
    <div class="section-inner">
      <div id="fundraiser-progress-section"></div>
      <article id="fundraiser-content" class="blog-post-content">
        <p>Loading fundraiser details...</p>
      </article>
      <div id="fundraiser-actions-section"></div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-inner">
      <div class="footer-top">
        <div class="footer-brand">
          <img src="images/logo.png" alt="Johnnie's Place" class="footer-logo">
          <p>Building community and providing safe housing for adults with autism.</p>
        </div>
        <div class="footer-col">
          <h4>Organization</h4>
          <a href="index.html">Home</a>
          <a href="about.html">About</a>
          <a href="mission.html">Mission</a>
        </div>
        <div class="footer-col">
          <h4>Get Involved</h4>
          <a href="support.html">Donate</a>
          <a href="events.html">Events</a>
          <a href="contact.html">Contact</a>
        </div>
        <div class="footer-col">
          <h4>Contact</h4>
          <p>318 East Elm Street<br>Conshohocken, PA 19428</p>
          <p>610 960 8205</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Johnnie's Place. All rights reserved. â€¢ <a href="/admin/" style="color: var(--text-muted); text-decoration: underline;">Admin Login</a></p>
        <p class="footer-legal">501(c)(3) Tax-Exempt Organization</p>
      </div>
    </div>
  </footer>

  <script src="js/main.js"></script>
  <script>
    // Get fundraiser ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const fundraiserId = urlParams.get('id');

    if (!fundraiserId) {
      document.getElementById('fundraiser-content').innerHTML = '<p>No fundraiser specified. <a href="fundraisers.html">Return to fundraisers</a></p>';
    } else {
      // Fetch and display the fundraiser
      fetch(`content/fundraisers/${fundraiserId}.md`)
        .then(response => {
          if (!response.ok) throw new Error('Fundraiser not found');
          return response.text();
        })
        .then(text => {
          // Parse frontmatter and content
          const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
          const match = text.match(frontmatterRegex);

          if (match) {
            const frontmatter = match[1];
            const content = match[2];

            // Parse YAML-like frontmatter
            const meta = {};
            let currentKey = null;

            frontmatter.split('\n').forEach(line => {
              const keyMatch = line.match(/^(\w+):\s*(.*)$/);
              if (keyMatch) {
                currentKey = keyMatch[1];
                const value = keyMatch[2].trim();
                if (value) {
                  meta[currentKey] = value.replace(/^["']|["']$/g, '');
                } else {
                  meta[currentKey] = {};
                }
              } else if (line.trim() && currentKey) {
                const subMatch = line.match(/^\s+(\w+):\s*(.*)$/);
                if (subMatch && typeof meta[currentKey] === 'object') {
                  meta[currentKey][subMatch[1]] = subMatch[2].trim().replace(/^["']|["']$/g, '');
                }
              }
            });

            // Update page title
            document.getElementById('page-title').textContent = meta.title + ' - Johnnie\'s Place';
            document.getElementById('fundraiser-title').textContent = meta.title;

            // Status badge
            if (meta.status && meta.status !== 'Active') {
              document.getElementById('fundraiser-meta').innerHTML = `
                <span class="fundraiser-status status-${meta.status.toLowerCase()}">${meta.status}</span>
              `;
            }

            // Event details
            if (meta.features && meta.features.show_event === 'true' && meta.event && meta.event.start_date) {
              const startDate = new Date(meta.event.start_date);
              const endDate = meta.event.end_date ? new Date(meta.event.end_date) : null;
              const dateStr = endDate
                ? `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`
                : startDate.toLocaleDateString();

              let eventHtml = `<div class="fundraiser-event" style="justify-content: center; margin: 16px 0;">`;
              eventHtml += `<span><strong>Dates:</strong> ${dateStr}</span>`;
              if (meta.event.location) {
                eventHtml += `<span><strong>Location:</strong> ${meta.event.location}</span>`;
              }
              eventHtml += `</div>`;
              document.getElementById('fundraiser-meta').innerHTML += eventHtml;
            }

            // Progress bar
            if (meta.features && meta.features.show_progress === 'true' && meta.financial && meta.financial.goal) {
              const goal = meta.financial.goal || '$0';
              const current = meta.financial.current || '$0';
              const goalNum = parseFloat(goal.replace(/[^0-9.]/g, ''));
              const currentNum = parseFloat(current.replace(/[^0-9.]/g, ''));
              const percentage = goalNum > 0 ? Math.min((currentNum / goalNum) * 100, 100) : 0;

              document.getElementById('fundraiser-progress-section').innerHTML = `
                <div class="fundraiser-progress" style="max-width: 800px; margin: 0 auto 40px;">
                  <div class="progress-stats">
                    <span class="progress-current">${current} raised</span>
                    <span class="progress-goal">of ${goal} goal</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                  </div>
                </div>
              `;
            }

            // Convert markdown to HTML and display
            document.getElementById('fundraiser-content').innerHTML = marked.parse(content);

            // Action buttons
            let actionsHtml = '';
            if (meta.features && (meta.features.enable_donations === 'true' || meta.features.enable_signups === 'true')) {
              actionsHtml = '<div class="fundraiser-actions" style="justify-content: center; margin-top: 48px;">';
              if (meta.features.enable_donations === 'true') {
                const donateUrl = (meta.links && meta.links.donate_url) || 'support.html';
                actionsHtml += `<a href="${donateUrl}" class="btn btn-primary btn-large">Support This Campaign</a>`;
              }
              if (meta.features.enable_signups === 'true' && meta.links && meta.links.signup_url) {
                actionsHtml += `<a href="${meta.links.signup_url}" class="btn btn-secondary btn-large">Sign Up</a>`;
              }
              if (meta.links && meta.links.info_url) {
                actionsHtml += `<a href="${meta.links.info_url}" class="btn btn-secondary btn-large">More Information</a>`;
              }
              actionsHtml += '</div>';
            }
            document.getElementById('fundraiser-actions-section').innerHTML = actionsHtml;

          } else {
            throw new Error('Invalid fundraiser format');
          }
        })
        .catch(error => {
          console.error('Error loading fundraiser:', error);
          document.getElementById('fundraiser-content').innerHTML = `
            <p>Sorry, we couldn't load this fundraiser. <a href="fundraisers.html">Return to fundraisers</a></p>
          `;
        });
    }

    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>
</body>
</html>
